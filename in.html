<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Astana Kitap - Книжный магазин</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb',
                        secondary: '#1e40af',
                        accent: '#F59E0B',
                        dark: '#1f2937',
                        light: '#f9fafb'
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }
        
        body {
            background-color: #f9fafb;
            color: #1f2937;
            transition: all 0.3s ease;
        }
        
        .book-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
        }
        
        .book-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        
        .cart-item {
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .like-animation {
            animation: like 0.5s ease;
        }
        
        @keyframes like {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }
        
        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .badge-popular {
            background-color: #F59E0B;
            color: white;
        }
        
        .badge-new {
            background-color: #10B981;
            color: white;
        }
        
        .badge-sale {
            background-color: #EF4444;
            color: white;
        }
        
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .section-title {
            position: relative;
            display: inline-block;
            margin-bottom: 2rem;
        }
        
        .section-title::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 0;
            width: 50px;
            height: 3px;
            background: #2563eb;
            border-radius: 2px;
        }
        
        .hero-pattern {
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            position: relative;
            overflow: hidden;
        }
        
        .hero-pattern::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.1'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        
        .glide__slide {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .glide__slide img {
            max-height: 400px;
            width: auto;
            max-width: 100%;
            object-fit: contain;
        }
        
        .recommendation-card {
            transition: all 0.3s ease;
        }
        
        .recommendation-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .newsletter-input {
            transition: all 0.3s ease;
        }
        
        .newsletter-input:focus {
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.3);
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2563eb;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .mobile-menu {
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }
        
        .mobile-menu.active {
            transform: translateX(0);
        }
        
        .back-to-top {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #2563eb;
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 40;
        }
        
        .back-to-top.visible {
            opacity: 1;
        }
        
        .book-detail-modal, .cart-modal, .checkout-modal, .favorites-modal, .pdf-modal {
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .book-detail-modal.active, .cart-modal.active, .checkout-modal.active, .favorites-modal.active, .pdf-modal.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }
        
        .book-detail-modal.active .modal-content, 
        .cart-modal.active .modal-content, 
        .checkout-modal.active .modal-content, 
        .favorites-modal.active .modal-content,
        .pdf-modal.active .modal-content {
            transform: translateY(0);
        }
        
        .book-detail-content {
            max-height: calc(90vh - 100px);
            overflow-y: auto;
        }
        
        @media (max-width: 768px) {
            .hero-pattern {
                padding: 3rem 1rem;
            }
            
            .hero-title {
                font-size: 2.5rem;
            }
            
            .section-title {
                font-size: 1.8rem;
            }
            
            .book-detail-content {
                max-height: calc(90vh - 70px);
            }
        }
        
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .line-clamp-3 {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center">
                <h1 class="text-2xl font-bold text-primary flex items-center">
                    <i class="fas fa-book-open mr-2"></i> Astana Kitap
                </h1>
                <nav class="hidden md:ml-8 md:flex space-x-6">
                    <a href="#catalog" class="text-gray-700 hover:text-primary font-medium">Каталог</a>
                    <a href="#about" class="text-gray-700 hover:text-primary font-medium">О нас</a>
                    <a href="#benefits" class="text-gray-700 hover:text-primary font-medium">Преимущества</a>
                    <a href="#contacts" class="text-gray-700 hover:text-primary font-medium">Контакты</a>
                </nav>
            </div>
            <div class="flex items-center space-x-4">
                <div class="relative hidden md:block">
                    <input type="text" placeholder="Поиск книг..." id="searchInput" 
                           class="pl-3 pr-10 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                    <i class="fas fa-search absolute right-3 top-3 text-gray-400"></i>
                </div>
                <select id="langSwitcher" class="border border-gray-300 rounded px-2 py-1 text-sm">
                    <option value="kk" selected>Қаз</option>
                    <option value="ru">Рус</option>
                  </select>
                <button id="cartButton" class="relative p-2 text-gray-700 hover:text-primary">
                    <i class="fas fa-shopping-cart text-xl"></i>
                    <span id="cartCount" class="absolute -top-1 -right-1 bg-primary text-white rounded-full w-5 h-5 flex items-center justify-center text-xs">0</span>
                </button>
                <button id="favoritesButton" class="p-2 text-gray-700 hover:text-primary relative">
                    <i class="fas fa-heart text-xl"></i>
                    <span id="favoritesCount" class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs">0</span>
                </button>
                
                <button class="md:hidden" id="mobileMenuButton">
                    <i class="fas fa-bars text-xl"></i>
                </button>
            </div>
        </div>
        
        <!-- Мобильное меню -->
        <div id="mobileMenu" class="mobile-menu fixed inset-0 bg-white z-50 md:hidden">
            <div class="container mx-auto px-4 py-6">
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-xl font-bold text-primary">Меню</h2>
                    <button id="closeMobileMenu" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>
                <div class="relative mb-6">
                    <input type="text" placeholder="Поиск книг..." id="searchInputMobile" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                </div>
                <nav class="flex flex-col space-y-4">
                    <a href="#catalog" class="text-gray-700 hover:text-primary font-medium py-2">Каталог</a>
                    <a href="#about" class="text-gray-700 hover:text-primary font-medium py-2">О нас</a>
                    <a href="#benefits" class="text-gray-700 hover:text-primary font-medium py-2">Преимущества</a>
                    <a href="#contacts" class="text-gray-700 hover:text-primary font-medium py-2">Контакты</a>
                </nav>
            </div>
        </div>
    </header>

    <!-- Hero Section -->
    <section class="hero-pattern text-white py-16 md:py-24 relative">
        <div class="container mx-auto px-4 text-center relative z-10">
            <h2 class="hero-title text-4xl md:text-5xl font-bold mb-4">Добро пожаловать в мир книг</h2>
            <p class="text-xl mb-8 max-w-2xl mx-auto">Откройте для себя тысячи книг на любой вкус в нашем магазине. Читайте, мечтайте, открывайте новое!</p>
            <a href="#catalog" class="bg-white text-primary px-6 py-3 rounded-lg font-medium hover:bg-gray-100 transition duration-300 inline-flex items-center">
                <i class="fas fa-book mr-2"></i> Смотреть каталог
            </a>
        </div>
    </section>

    <!-- Stats Section -->
    <section class="bg-white py-12">
        <div class="container mx-auto px-4">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-6 text-center">
                <div class="p-4">
                    <div class="text-3xl font-bold text-primary">10,000+</div>
                    <div class="text-gray-600">Книг в каталоге</div>
                </div>
                <div class="p-4">
                    <div class="text-3xl font-bold text-primary">5,000+</div>
                    <div class="text-gray-600">Довольных клиентов</div>
                </div>
                <div class="p-4">
                    <div class="text-3xl font-bold text-primary">15</div>
                    <div class="text-gray-600">Лет на рынке</div>
                </div>
                <div class="p-4">
                    <div class="text-3xl font-bold text-primary">24/7</div>
                    <div class="text-gray-600">Поддержка</div>
                </div>
            </div>
        </div>
    </section>

    <!-- Catalog Section -->
    <section id="catalog" class="py-16 bg-gray-50">
        <div class="container mx-auto px-4">
            <h2 class="text-3xl font-bold text-dark mb-2 section-title">Каталог книг</h2>
            <p class="text-gray-600 mb-10">Найдите свою следующую любимую книгу в нашем обширном каталоге</p>
            
            <div class="flex flex-col md:flex-row justify-between items-center mb-8 bg-white p-4 rounded-lg shadow-sm">
                <div class="flex flex-wrap gap-3 mb-4 md:mb-0">
                    <select id="genreFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                        <option value="">Все жанры</option>
                    </select>
                    <select id="priceFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                        <option value="">Любая цена</option>
                        <option value="0-5000">До 5,000 ₸</option>
                        <option value="5000-10000">5,000 - 10,000 ₸</option>
                        <option value="10000-20000">10,000 - 20,000 ₸</option>
                        <option value="20000+">От 20,000 ₸</option>
                    </select>
                </div>
                <select id="sortFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                    <option value="popularity">По популярности</option>
                    <option value="price-asc">Цена по возрастанию</option>
                    <option value="price-desc">Цена по убыванию</option>
                    <option value="newest">Сначала новые</option>
                </select>
            </div>
            
            <div id="booksContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                <div class="text-center py-10 col-span-full">
                    <div class="loading-spinner"></div>
                    <p class="mt-4 text-gray-600">Загрузка книг...</p>
                </div>
            </div>
        </div>
    </section>

    <!-- About Section -->
    <section id="about" class="py-16 bg-white">
        <div class="container mx-auto px-4">
            <div class="flex flex-col md:flex-row items-center gap-10">
                <div class="w-full md:w-1/2">
                    <h2 class="text-3xl font-bold text-dark mb-2 section-title">О нашем магазине</h2>
                    <p class="text-gray-700 mb-6">Astana Kitap - это современный книжный магазин, предлагающий широкий выбор литературы различных жанров. Мы стремимся сделать чтение доступным и приятным для всех жителей Астаны и Казахстана.</p>
                    <p class="text-gray-700 mb-6">Наша миссия - распространять знания и культуру через книгу, делая качественную литературу доступной для каждого.</p>
                    <div class="flex space-x-4">
                        <div class="bg-primary text-white px-4 py-2 rounded-lg font-medium">10+ лет</div>
                        <div class="bg-primary text-white px-4 py-2 rounded-lg font-medium">10000+ книг</div>
                        <div class="bg-primary text-white px-4 py-2 rounded-lg font-medium">5000+ клиентов</div>
                    </div>
                </div>
                <div class="w-full md:w-1/2">
                    <img src="https://i.pinimg.com/736x/f8/32/bf/f832bffe2cee482b6809be4148a2055f.jpg" alt="Книжный магазин" class="rounded-lg shadow-lg">
                </div>
            </div>
        </div>
    </section>

    <!-- Benefits Section -->
    <section id="benefits" class="py-16 bg-gray-50">
        <div class="container mx-auto px-4">
            <h2 class="text-3xl font-bold text-dark mb-2 section-title">Наши преимущества</h2>
            <p class="text-gray-600 mb-12">Почему выбирают именно наш книжный магазин</p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
                <div class="bg-white p-6 rounded-lg shadow-sm text-center">
                    <div class="bg-primary w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-shipping-fast text-white text-2xl"></i>
                    </div>
                    <h3 class="text-xl font-semibold mb-2">Быстрая доставка</h3>
                    <p class="text-gray-600">Доставка по всему Казахстану в кратчайшие сроки</p>
                </div>
                
                <div class="bg-white p-6 rounded-lg shadow-sm text-center">
                    <div class="bg-primary w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-book-open text-white text-2xl"></i>
                    </div>
                    <h3 class="text-xl font-semibold mb-2">Широкий ассортимент</h3>
                    <p class="text-gray-600">Тысячи книг различных жанров и направлений</p>
                </div>
                
                <div class="bg-white p-6 rounded-lg shadow-sm text-center">
                    <div class="bg-primary w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-headset text-white text-2xl"></i>
                    </div>
                    <h3 class="text-xl font-semibold mb-2">Поддержка 24/7</h3>
                    <p class="text-gray-600">Всегда готовы ответить на ваши вопросы</p>
                </div>
                
                <div class="bg-white p-6 rounded-lg shadow-sm text-center">
                    <div class="bg-primary w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-tag text-white text-2xl"></i>
                    </div>
                    <h3 class="text-xl font-semibold mb-2">Выгодные цены</h3>
                    <p class="text-gray-600">Конкурентные цены и регулярные акции</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Testimonials Section -->
    <section class="py-16 bg-white">
        <div class="container mx-auto px-4">
            <h2 class="text-3xl font-bold text-dark mb-2 section-title">Отзывы клиентов</h2>
            <p class="text-gray-600 mb-12">Что говорят наши читатели</p>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="bg-gray-50 p-6 rounded-lg shadow-sm">
                    <div class="flex text-yellow-400 mb-4">
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                    </div>
                    <p class="text-gray-700 mb-4">"Отличный магазин с большим выбором книг. Быстрая доставка и приятные цены. Рекомендую!"</p>
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-primary rounded-full flex items-center justify-center text-white font-bold mr-3">АС</div>
                        <div>
                            <h4 class="font-semibold">Алия Смагулова</h4>
                            <p class="text-gray-600 text-sm">Постоянный клиент</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gray-50 p-6 rounded-lg shadow-sm">
                    <div class="flex text-yellow-400 mb-4">
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                    </div>
                    <p class="text-gray-700 mb-4">"Заказываю книги регулярно. Всегда быстрая доставка и книги в идеальном состоянии. Спасибо!"</p>
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-primary rounded-full flex items-center justify-center text-white font-bold mr-3">ДК</div>
                        <div>
                            <h4 class="font-semibold">Дмитрий Ким</h4>
                            <p class="text-gray-600 text-sm">Читатель</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gray-50 p-6 rounded-lg shadow-sm">
                    <div class="flex text-yellow-400 mb-4">
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star-half-alt"></i>
                    </div>
                    <p class="text-gray-700 mb-4">"Очень удобный сайт, легко найти нужную книгу. Консультанты помогли с выбором. Буду заказывать еще!"</p>
                    <div class="flex items-center">
                        <div class="w-10 h-10 bg-primary rounded-full flex items-center justify-center text-white font-bold mr-3">МА</div>
                        <div>
                            <h4 class="font-semibold">Мария Абдрахманова</h4>
                            <p class="text-gray-600 text-sm">Новый клиент</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Newsletter Section -->
    <section class="py-16 bg-primary text-white">
        <div class="container mx-auto px-4 text-center">
            <h2 class="text-3xl font-bold mb-4">Подпишитесь на рассылку</h2>
            <p class="text-white opacity-90 mb-8 max-w-2xl mx-auto">Узнавайте первыми о новых поступлениях, акциях и специальных предложениях</p>
            
            <div class="max-w-md mx-auto flex">
                <input type="email" placeholder="Ваш email" class="flex-1 px-4 py-3 rounded-l-lg focus:outline-none text-gray-800 newsletter-input">
                <button class="bg-accent px-6 py-3 rounded-r-lg hover:bg-yellow-600 transition">Подписаться</button>
            </div>
        </div>
    </section>

    <!-- Contacts Section -->
    <section id="contacts" class="py-16 bg-white">
        <div class="container mx-auto px-4">
            <h2 class="text-3xl font-bold text-dark mb-2 section-title">Контакты</h2>
            <p class="text-gray-600 mb-12">Свяжитесь с нами любым удобным способом</p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
                <div>
                    <div class="mb-6">
                        <h3 class="text-xl font-semibold mb-4">Адрес</h3>
                        <p class="text-gray-700 mb-2"><i class="fas fa-map-marker-alt text-primary mr-2"></i> г. Астана, ул. Книжная, 123</p>
                        <p class="text-gray-700">ТРЦ "Москва", 3 этаж</p>
                    </div>
                    
                    <div class="mb-6">
                        <h3 class="text-xl font-semibold mb-4">Телефон</h3>
                        <p class="text-gray-700"><i class="fas fa-phone text-primary mr-2"></i> +7 (777) 123-45-67</p>
                    </div>
                    
                    <div class="mb-6">
                        <h3 class="text-xl font-semibold mb-4">Email</h3>
                        <p class="text-gray-700"><i class="fas fa-envelope text-primary mr-2"></i> info@astanakitap.kz</p>
                    </div>
                    
                    <div class="mb-6">
                        <h3 class="text-xl font-semibold mb-4">Режим работы</h3>
                        <p class="text-gray-700 mb-1"><i class="fas fa-clock text-primary mr-2"></i> Пн-Пт: 9:00 - 21:00</p>
                        <p class="text-gray-700 mb-1">Сб-Вс: 10:00 - 20:00</p>
                    </div>
                </div>
                
                <div>
                    <div class="bg-gray-100 p-6 rounded-lg">
                        <h3 class="text-xl font-semibold mb-4">Напишите нам</h3>
                        <form>
                            <div class="mb-4">
                                <input type="text" placeholder="Ваше имя" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                            </div>
                            <div class="mb-4">
                                <input type="email" placeholder="Ваш email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                            </div>
                            <div class="mb-4">
                                <textarea placeholder="Ваше сообщение" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary"></textarea>
                            </div>
                            <button type="submit" class="bg-primary text-white px-6 py-2 rounded-lg hover:bg-secondary transition">Отправить</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-dark text-white py-12">
        <div class="container mx-auto px-4">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                <div>
                    <h3 class="text-xl font-bold mb-4">Astana Kitap</h3>
                    <p class="text-gray-300">Лучший книжный магазин в Астане с широким выбором литературы на любой вкус.</p>
                </div>
                <div>
                    <h3 class="text-xl font-bold mb-4">Каталог</h3>
                    <ul class="space-y-2">
                        <li><a href="#" class="text-gray-300 hover:text-white">Художественная литература</a></li>
                        <li><a href="#" class="text-gray-300 hover:text-white">Деловая литература</a></li>
                        <li><a href="#" class="text-gray-300 hover:text-white">Детские книги</a></li>
                        <li><a href="#" class="text-gray-300 hover:text-white">Образование</a></li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-xl font-bold mb-4">Контакты</h3>
                    <p class="text-gray-300 mb-2"><i class="fas fa-map-marker-alt mr-2"></i> г. Астана, ул. Книжная, 123</p>
                    <p class="text-gray-300 mb-2"><i class="fas fa-phone mr-2"></i> +7 (777) 123-45-67</p>
                    <p class="text-gray-300 mb-2"><i class="fas fa-envelope mr-2"></i> info@astanakitap.kz</p>
                </div>
                <div>
                    <h3 class="text-xl font-bold mb-4">Мы в соцсетях</h3>
                    <div class="flex space-x-4 mb-6">
                        <a href="#" class="text-gray-300 hover:text-white"><i class="fab fa-instagram text-2xl"></i></a>
                        <a href="#" class="text-gray-300 hover:text-white"><i class="fab fa-facebook text-2xl"></i></a>
                        <a href="#" class="text-gray-300 hover:text-white"><i class="fab fa-telegram text-2xl"></i></a>
                        <a href="#" class="text-gray-300 hover:text-white"><i class="fab fa-whatsapp text-2xl"></i></a>
                    </div>
                    <div class="mt-6">
                        <h4 class="font-medium mb-2">Способы оплаты</h4>
                        <div class="flex space-x-2">
                            <div class="bg-white p-1 rounded">
                                <i class="fab fa-cc-visa text-2xl text-blue-800"></i>
                            </div>
                            <div class="bg-white p-1 rounded">
                                <i class="fab fa-cc-mastercard text-2xl text-red-700"></i>
                            </div>
                            <div class="bg-white p-1 rounded">
                                <i class="fab fa-cc-amex text-2xl text-blue-600"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="border-t border-gray-700 mt-8 pt-8 text-center text-gray-400">
                <p>&copy; 2023 Astana Kitap. Все права защищены.</p>
            </div>
        </div>
    </footer>

    <!-- Back to Top Button -->
    <div class="back-to-top" id="backToTop">
        <i class="fas fa-arrow-up"></i>
    </div>

    <!-- Book Detail Modal -->
    <div id="bookDetailModal" class="book-detail-modal fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold" id="bookDetailTitle">Детали книги</h3>
                <button id="closeBookDetail" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="book-detail-content overflow-y-auto p-6">
                <div class="flex flex-col md:flex-row gap-6 mb-8">
                    <div class="w-full md:w-1/3">
                        <div id="detailGallery" class="flex flex-col gap-2">
                          <!-- сюда будут добавляться картинки -->
                        </div>
                      </div>
                    <div class="w-full md:w-2/3">
                        <h2 class="text-2xl font-bold mb-2" id="detailTitle"></h2>
                        <p class="text-gray-600 mb-4" id="detailAuthor"></p>
                        <div class="flex items-center mb-4">
                            <div class="flex text-yellow-400 mr-2">
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star-half-alt"></i>
                            </div>
                            <span class="text-gray-600" id="detailRating">4.5 (120 отзывов)</span>
                        </div>
                        <p class="text-gray-700 mb-6 line-clamp-3" id="detailDescription"></p>
                        <div class="flex items-center mb-6">
                            <span class="text-2xl font-bold text-primary mr-3" id="detailPrice"></span>
                            <span class="text-green-600 font-medium" id="detailDiscount"></span>
                        </div>
                        <div class="flex space-x-4 mb-6">
                            <button class="add-to-cart-detail bg-primary text-white px-6 py-3 rounded-lg font-medium hover:bg-secondary transition duration-300 flex items-center">
                              <i class="fas fa-shopping-cart mr-2"></i> В корзину
                            </button>
                          
                            <a id="kaspiBuyDetail" href="#" target="_blank" rel="noopener"
                                class="hidden bg-red-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-red-700 transition duration-300 flex items-center space-x-2">
                                <img src="kaspi.png" alt="Kaspi" class="w-6 h-6">
                                <span>Купить в Kaspi</span>
                                </a>
                          
                            <button class="like-button-detail p-3 text-gray-400 hover:text-red-500 border border-gray-300 rounded-lg">
                              <i class="fas fa-heart"></i>
                            </button>
                          </div>
                        <div class="border-t pt-4">
                            <h4 class="font-bold mb-2">Характеристики</h4>
                            <div class="grid grid-cols-2 gap-2 text-sm">
                                <div class="text-gray-600">Жанр:</div>
                                <div class="font-medium" id="detailGenre"></div>
                                <div class="text-gray-600">Год издания:</div>
                                <div class="font-medium" id="detailYear">2023</div>
                                <div class="text-gray-600">Страниц:</div>
                                <div class="font-medium" id="detailPages">320</div>
                                <div class="text-gray-600">ISBN:</div>
                                <div class="font-medium" id="detailISBN">978-5-001-23456-7</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Recommendations Section -->
                <div class="border-t pt-8">
                    <h3 class="text-xl font-bold mb-6">Рекомендуемые книги</h3>
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4" id="recommendationsContainer">
                        <!-- Recommendations will be added here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cart Modal -->
    <div id="cartModal" class="cart-modal fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold">Корзина</h3>
                <button id="closeCart" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="overflow-y-auto flex-grow p-6">
                <div id="cartItems" class="space-y-4">
                    <!-- Товары в корзине будут добавлены здесь -->
                    <div id="emptyCart" class="text-center py-10">
                        <i class="fas fa-shopping-cart text-gray-300 text-4xl mb-3"></i>
                        <p class="text-gray-500">Ваша корзина пуста</p>
                    </div>
                </div>
            </div>
            <div class="p-6 border-t">
                <div class="flex justify-between mb-4">
                    <span class="font-medium">Общая сумма:</span>
                    <span id="cartTotal" class="font-bold">0 ₸</span>
                </div>
                <button id="checkoutButton" class="w-full bg-primary text-white py-3 rounded-lg font-medium hover:bg-secondary transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    Оформить заказ
                </button>
            </div>
        </div>
    </div>

    <!-- Checkout Modal -->
    <div id="checkoutModal" class="checkout-modal fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold">Оформление заказа</h3>
                <button id="closeCheckout" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="checkoutForm" class="p-6 space-y-4">
                <div>
                    <label for="name" class="block mb-1 font-medium">Имя и фамилия *</label>
                    <input type="text" id="name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                </div>
                <div>
                    <label for="phone" class="block mb-1 font-medium">Номер телефона *</label>
                    <input type="tel" id="phone" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                </div>
                <div>
                    <label for="email" class="block mb-1 font-medium">Email</label>
                    <input type="email" id="email" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                </div>
                <div>
                    <label for="city" class="block mb-1 font-medium">Город *</label>
                    <select id="city" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                        <option value="">Выберите город</option>
                        <option value="astana">Астана</option>
                        <option value="almaty">Алматы</option>
                        <option value="shymkent">Шымкент</option>
                        <option value="karaganda">Караганда</option>
                        <option value="other">Другой</option>
                    </select>
                </div>
                <div>
                    <label for="address" class="block mb-1 font-medium">Адрес *</label>
                    <textarea id="address" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" rows="2"></textarea>
                </div>
                <div>
                    <label class="block mb-1 font-medium">Способ оплаты *</label>
                    <div class="space-y-2">
                        <label class="flex items-center">
                            <input type="radio" name="payment" value="cash" required class="mr-2">
                            <span>Наличными при получении</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="payment" value="card" class="mr-2">
                            <span>Банковской картой онлайн</span>
                        </label>
                    </div>
                </div>
                <div class="pt-4">
                    <button type="submit" class="w-full bg-primary text-white py-3 rounded-lg font-medium hover:bg-secondary transition duration-300">
                        Подтвердить заказ
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- PDF Viewer Modal -->
    <div id="pdfModal" class="pdf-modal fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-4xl h-[90vh] flex flex-col">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 id="pdfTitle" class="text-xl font-bold">Просмотр PDF</h3>
                <button id="closePdf" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="flex-grow">
                <iframe id="pdfViewer" class="w-full h-full" frameborder="0"></iframe>
            </div>
        </div>
    </div>

    <!-- Favorites Modal -->
    <div id="favoritesModal" class="favorites-modal fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="modal-content bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-hidden flex flex-col">
            <div class="p-6 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold">Избранное</h3>
                <button id="closeFavorites" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="overflow-y-auto flex-grow p-6">
                <div id="favoritesContainer" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <!-- Избранные книги будут здесь -->
                    <div id="emptyFavorites" class="text-center py-10 col-span-2">
                        <i class="fas fa-heart text-gray-300 text-4xl mb-3"></i>
                        <p class="text-gray-500">У вас пока нет избранных книг</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Glide.js -->
    

    <script>
    /* ======================== КОНФИГ ======================== */
    const GOOGLE_SHEETS_ID = '176zOXars8cF-sQh1R38PLXicZwjtZnWFdd7t16CdW8k';
    const WHATSAPP_NUMBER = '77479894879';
    
    /* ======================== ГЛОБАЛЬНО ======================== */
    let books = [];
    let cart = (JSON.parse(localStorage.getItem('cart')) || []).map(i => ({...i, id: String(i.id)}));
    let favorites = (JSON.parse(localStorage.getItem('favorites')) || []).map(String);
    let currentBook = null;
    
    /* ======================== DOM ======================== */
    const booksContainer   = document.getElementById('booksContainer');
    const cartItems        = document.getElementById('cartItems');
    const cartTotal        = document.getElementById('cartTotal');
    const cartCount        = document.getElementById('cartCount');
    const favoritesCount   = document.getElementById('favoritesCount');
    const cartModal        = document.getElementById('cartModal');
    const checkoutModal    = document.getElementById('checkoutModal');
    const pdfModal         = document.getElementById('pdfModal');
    const favoritesModal   = document.getElementById('favoritesModal');
    const bookDetailModal  = document.getElementById('bookDetailModal');
    const cartButton       = document.getElementById('cartButton');
    const checkoutButton   = document.getElementById('checkoutButton');
    const closeCart        = document.getElementById('closeCart');
    const closeCheckout    = document.getElementById('closeCheckout');
    const closePdf         = document.getElementById('closePdf');
    const closeFavorites   = document.getElementById('closeFavorites');
    const closeBookDetail  = document.getElementById('closeBookDetail');
    const checkoutForm     = document.getElementById('checkoutForm');
    const pdfViewer        = document.getElementById('pdfViewer');
    const pdfTitle         = document.getElementById('pdfTitle');
    const searchInput      = document.getElementById('searchInput');
    const searchInputMobile= document.getElementById('searchInputMobile');
    const genreFilter      = document.getElementById('genreFilter');
    const priceFilter      = document.getElementById('priceFilter');
    const sortFilter       = document.getElementById('sortFilter');
    const favoritesButton  = document.getElementById('favoritesButton');
    const favoritesContainer = document.getElementById('favoritesContainer');
    const mobileMenuButton = document.getElementById('mobileMenuButton');
    const mobileMenu       = document.getElementById('mobileMenu');
    const closeMobileMenu  = document.getElementById('closeMobileMenu');
    const backToTop        = document.getElementById('backToTop');
    const recommendationsContainer = document.getElementById('recommendationsContainer');
    const kaspiBuyDetail = document.getElementById('kaspiBuyDetail');

    /* — элементы деталей книги — */
    const detailTitle      = document.getElementById('detailTitle');
    const detailAuthor     = document.getElementById('detailAuthor');
    const detailDescription= document.getElementById('detailDescription');
    const detailPrice      = document.getElementById('detailPrice');
    const detailDiscount   = document.getElementById('detailDiscount');
    const detailGenre      = document.getElementById('detailGenre');
    const gallerySlides    = document.getElementById('gallerySlides');
    const addToCartDetail  = document.querySelector('.add-to-cart-detail');
    const likeButtonDetail = document.querySelector('.like-button-detail');
    
    /* ======================== УТИЛИТЫ ======================== */
    const asId = v => String(v);
    const findBook = (id) => books.find(b => asId(b.id) === asId(id));
    
    function toggleModal(modal) {
      modal.classList.toggle('active');
      document.body.style.overflow = modal.classList.contains('active') ? 'hidden' : '';
    }
    function showNotification(message, type = 'info') {
      const el = document.createElement('div');
      el.className = `fixed top-4 right-4 px-4 py-2 rounded-lg shadow-lg text-white font-medium z-50 transition-transform transform translate-x-full ${type==='success'?'bg-green-500':type==='error'?'bg-red-500':'bg-blue-500'}`;
      el.textContent = message;
      document.body.appendChild(el);
      setTimeout(()=>el.classList.remove('translate-x-full'),10);
      setTimeout(()=>{ el.classList.add('translate-x-full'); setTimeout(()=>el.remove(),300); },3000);
    }
    
    /* ======== Google Drive helpers ======== */
    /* ======== Google Drive helpers (robust) ======== */
/* ======== Google Drive helpers (single image) ======== */
function getDriveId(raw) {
  if (!raw) return null;
  const url = String(raw).trim();

  // /file/d/ID/
  let m = url.match(/\/file\/d\/([a-zA-Z0-9_-]{10,})/);
  if (m) return m[1];

  // ?id=ID (open?id=, uc?id=, thumbnail?id=...)
  m = url.match(/[?&]id=([a-zA-Z0-9_-]{10,})/);
  if (m) return m[1];

  return null;
}

// Прямая ссылка на изображение (через CDN). Работает для JPG/PNG/WebP.
// Если файл в Drive НЕ изображение (PDF/Docs) — <img> не покажет.
function driveImage(rawUrl, size = 800) {
  const id = getDriveId(rawUrl);
  if (!id) return '';
  // Основной вариант — CDN:
  return `https://lh3.googleusercontent.com/d/${id}=w${size}`;
}

// Резервная ссылка (для <iframe> PDF)
function drivePdf(rawUrl) {
  const id = getDriveId(rawUrl);
  return id ? `https://drive.google.com/file/d/${id}/preview` : '';
}

// Поддержка нескольких ссылок через запятую
function processImageUrls(imageString) {
  if (!imageString) return [];
  return imageString
    .split(/[,\s;]+/)           // запятая ИЛИ пробелы ИЛИ ; 
    .map(s => s.trim())
    .filter(Boolean)
    .map(driveImage)
    .filter(Boolean);
}

/* ======================== ЯЗЫКИ ======================== */
/* ======================== ЯЗЫКИ ======================== */
const translations = {
  kk: {
    // Header / nav
    brand: "Astana Kitap",
    catalog: "Каталог",
    about: "Біз туралы",
    benefits: "Артықшылықтар",
    contacts: "Байланыс",
    search: "Кітап іздеу...",
    cart: "Себет",
    favorites: "Таңдаулылар",
    menu: "Мәзір",

    // Hero
    welcome: "Кітаптар әлеміне қош келдіңіз",
    heroText: "Біздің дүкенде кез келген талғамға арналған мыңдаған кітаптарды ашыңыз. Оқыңыз, армандаңыз, жаңа дүниелерді таныңыз!",
    seeCatalog: "Каталогты қарау",

    // Stats
    statsBooks: "Каталогтағы кітаптар",
    statsClients: "Қанағаттанған клиенттер",
    statsYears: "Жыл нарықта",
    statsSupport: "Тәулік бойы қолдау",

    // Catalog section
    catalogTitle: "Кітаптар каталогы",
    catalogSubtitle: "Біздің кең каталогтан келесі сүйікті кітабыңызды табыңыз",
    allGenres: "Барлық жанрлар",
    anyPrice: "Кез келген баға",
    price_upto_5k: "5 000 ₸ дейін",
    price_5_10k: "5 000 - 10 000 ₸",
    price_10_20k: "10 000 - 20 000 ₸",
    price_20k_plus: "20 000 ₸ бастап",
    sortPopularity: "Танымалдылығы бойынша",
    sortPriceAsc: "Баға ↑",
    sortPriceDesc: "Баға ↓",
    sortNewest: "Жаңалар алдымен",
    loadingBooks: "Кітаптар жүктелуде...",
    notFound: "Кітаптар табылмады",

    // About
    aboutTitle: "Біздің дүкен туралы",
    aboutText1: "Astana Kitap — түрлі жанрдағы әдебиеттердің кең таңдауын ұсынатын заманауи кітап дүкені. Біз оқуды Астана және Қазақстан тұрғындары үшін қолжетімді әрі қызықты етуге тырысамыз.",
    aboutText2: "Біздің миссиямыз — білім мен мәдениетті тарату, сапалы кітаптарды әр адамға жеткізу.",
    aboutYears: "10+ жыл",
    aboutBooks: "10000+ кітап",
    aboutClients: "5000+ клиент",
    aboutImgAlt: "Кітап дүкені",

    // Benefits
    benefitsTitle: "Біздің артықшылықтарымыз",
    benefitsSubtitle: "Неліктен біздің кітап дүкенін таңдайды",
    benefit1: "Жылдам жеткізу",
    benefit1text: "Қазақстан бойынша қысқа мерзімде жеткіземіз",
    benefit2: "Кең ассортимент",
    benefit2text: "Әртүрлі жанрдағы мыңдаған кітаптар",
    benefit3: "24/7 қолдау",
    benefit3text: "Сұрақтарыңызға әрқашан жауап береміз",
    benefit4: "Тиімді бағалар",
    benefit4text: "Бәсекеге қабілетті бағалар және тұрақты акциялар",

    // Testimonials
    testimonials: "Клиенттердің пікірлері",
    testimonialsSubtitle: "Біздің оқырмандар не дейді",
    review1: "«Кітаптардың таңдауы көп. Жеткізу жылдам, бағалары жағымды. Ұсынамын!»",
    review1_name: "Алия Смагулова",
    review1_role: "Тұрақты клиент",
    review2: "«Үнемі тапсырыс беремін. Жеткізу тез, кітаптар мінсіз күйде келеді. Рахмет!»",
    review2_name: "Дмитрий Ким",
    review2_role: "Оқырман",
    review3: "«Сайт өте ыңғайлы, кітап табу оңай. Кеңесшілер көмектесті. Тағы да тапсырыс беремін!»",
    review3_name: "Мария Абдрахманова",
    review3_role: "Жаңа клиент",

    // Newsletter
    newsletter: "Жаңалықтарға жазылыңыз",
    newsletterText: "Жаңа түсімдер, акциялар мен арнайы ұсыныстарды бірінші болып біліңіз",
    newsletterPlaceholder: "Сіздің email",
    subscribe: "Жазылу",

    // Contacts
    contactsTitle: "Байланыс",
    contactsSubtitle: "Бізбен кез келген ыңғайлы тәсілмен хабарласыңыз",
    address: "Мекенжай",
    phone: "Телефон",
    email: "Email",
    schedule: "Жұмыс уақыты",
    scheduleWork: "Дс-Жм: 9:00 - 21:00",
    scheduleWeekend: "Сб-Жс: 10:00 - 20:00",
    writeUs: "Бізге жазыңыз",
    formName: "Атыңыз",
    formEmail: "Сіздің email",
    formMsg: "Хабарыңыз",
    send: "Жіберу",

    // Footer
    footerText: "Астанадағы ең үздік кітап дүкені. Кез келген талғамға арналған әдебиет.",
    footerCatalog: "Каталог",
    footerFiction: "Көркем әдебиет",
    footerBiz: "Іскери әдебиет",
    footerKids: "Балалар кітаптары",
    footerEdu: "Білім",
    footerContacts: "Байланыс",
    social: "Біз әлеуметтік желілерде",
    payments: "Төлем тәсілдері",
    rights: "Барлық құқықтар қорғалған.",

    // Modals: detail
    bookDetails: "Кітап туралы",
    ratingText: (n)=>`4.5 (${n} пікір)`,
    descriptionMissing: "Сипаттама жоқ",
    unknownAuthor: "Автор белгісіз",
    noPrice: "Баға көрсетілмеген",
    noGenre: "Жанр көрсетілмеген",
    addToCartBtn: "Себетке салу",
    buyInKaspi: "Kaspi-де сатып алу",
    characteristics: "Сипаттамалар",
    genre: "Жанр:",
    year: "Жарық көрген жылы:",
    pages: "Бет саны:",
    isbn: "ISBN:",
    recommendations: "Ұсынылатын кітаптар",
    noRecs: "Ұсыныстар жоқ",

    // Cart / favorites / checkout
    cartTitle: "Себет",
    emptyCart: "Себетіңіз бос",
    total: "Жалпы сома:",
    checkout: "Тапсырыс беру",
    checkoutTitle: "Тапсырыс рәсімдеу",
    nameLabel: "Аты-жөні *",
    phoneLabel: "Телефон нөмірі *",
    cityLabel: "Қала *",
    addressLabel: "Мекенжай *",
    paymentMethod: "Төлем тәсілі *",
    cash: "Қолма-қол алған кезде",
    card: "Онлайн карта арқылы",
    confirmOrder: "Тапсырысты растау",
    chooseCity: "Қаланы таңдаңыз",
    cityAst: "Астана",
    cityAlm: "Алматы",
    cityShy: "Шымкент",
    cityKar: "Қарағанды",
    cityOther: "Басқа",
    favoritesTitle: "Таңдаулылар",
    emptyFavorites: "Әзірге таңдаулыларда кітап жоқ",
    pdfTitle: "PDF қарау",

    // Buttons / tooltips (render)
    viewDetails: "Қарау",
    inCart: "Себетке",
    inFav: "Таңдаулыға",
    openPdf: "PDF ашу",

    // Notifications
    addedToCart: (t)=>`«${t}» себетке қосылды`,
    removedFromCart: (t)=>`«${t}» себеттен өшірілді`,
    addedToFav: (t)=>`«${t}» таңдаулыларға қосылды`,
    removedFromFav: (t)=>`«${t}» таңдаулылардан өшірілді`,
  },

  ru: {
    brand: "Astana Kitap",
    catalog: "Каталог",
    about: "О нас",
    benefits: "Преимущества",
    contacts: "Контакты",
    search: "Поиск книг...",
    cart: "Корзина",
    favorites: "Избранное",
    menu: "Меню",

    welcome: "Добро пожаловать в мир книг",
    heroText: "Откройте для себя тысячи книг на любой вкус в нашем магазине. Читайте, мечтайте, открывайте новое!",
    seeCatalog: "Смотреть каталог",

    statsBooks: "Книг в каталоге",
    statsClients: "Довольных клиентов",
    statsYears: "Лет на рынке",
    statsSupport: "Поддержка 24/7",

    catalogTitle: "Каталог книг",
    catalogSubtitle: "Найдите свою следующую любимую книгу в нашем обширном каталоге",
    allGenres: "Все жанры",
    anyPrice: "Любая цена",
    price_upto_5k: "До 5,000 ₸",
    price_5_10k: "5,000 - 10,000 ₸",
    price_10_20k: "10,000 - 20,000 ₸",
    price_20k_plus: "От 20,000 ₸",
    sortPopularity: "По популярности",
    sortPriceAsc: "Цена ↑",
    sortPriceDesc: "Цена ↓",
    sortNewest: "Сначала новые",
    loadingBooks: "Загрузка книг...",
    notFound: "Книги не найдены",

    aboutTitle: "О нашем магазине",
    aboutText1: "Astana Kitap - это современный книжный магазин, предлагающий широкий выбор литературы различных жанров. Мы стремимся сделать чтение доступным и приятным для всех жителей Астаны и Казахстана.",
    aboutText2: "Наша миссия - распространять знания и культуру через книгу, делая качественную литературу доступной для каждого.",
    aboutYears: "10+ лет",
    aboutBooks: "10000+ книг",
    aboutClients: "5000+ клиентов",
    aboutImgAlt: "Книжный магазин",

    benefitsTitle: "Наши преимущества",
    benefitsSubtitle: "Почему выбирают именно наш книжный магазин",
    benefit1: "Быстрая доставка",
    benefit1text: "Доставка по всему Казахстану в кратчайшие сроки",
    benefit2: "Широкий ассортимент",
    benefit2text: "Тысячи книг различных жанров и направлений",
    benefit3: "Поддержка 24/7",
    benefit3text: "Всегда готовы ответить на ваши вопросы",
    benefit4: "Выгодные цены",
    benefit4text: "Конкурентные цены и регулярные акции",

    testimonials: "Отзывы клиентов",
    testimonialsSubtitle: "Что говорят наши читатели",
    review1: "«Отличный магазин с большим выбором книг. Быстрая доставка и приятные цены. Рекомендую!»",
    review1_name: "Алия Смагулова",
    review1_role: "Постоянный клиент",
    review2: "«Заказываю книги регулярно. Всегда быстрая доставка и книги в идеальном состоянии. Спасибо!»",
    review2_name: "Дмитрий Ким",
    review2_role: "Читатель",
    review3: "«Очень удобный сайт, легко найти нужную книгу. Консультанты помогли с выбором. Буду заказывать еще!»",
    review3_name: "Мария Абдрахманова",
    review3_role: "Новый клиент",

    newsletter: "Подпишитесь на рассылку",
    newsletterText: "Узнавайте первыми о новых поступлениях, акциях и специальных предложениях",
    newsletterPlaceholder: "Ваш email",
    subscribe: "Подписаться",

    contactsTitle: "Контакты",
    contactsSubtitle: "Свяжитесь с нами любым удобным способом",
    address: "Адрес",
    phone: "Телефон",
    email: "Email",
    schedule: "Режим работы",
    scheduleWork: "Пн-Пт: 9:00 - 21:00",
    scheduleWeekend: "Сб-Вс: 10:00 - 20:00",
    writeUs: "Напишите нам",
    formName: "Ваше имя",
    formEmail: "Ваш email",
    formMsg: "Ваше сообщение",
    send: "Отправить",

    footerText: "Лучший книжный магазин в Астане с широким выбором литературы на любой вкус.",
    footerCatalog: "Каталог",
    footerFiction: "Художественная литература",
    footerBiz: "Деловая литература",
    footerKids: "Детские книги",
    footerEdu: "Образование",
    footerContacts: "Контакты",
    social: "Мы в соцсетях",
    payments: "Способы оплаты",
    rights: "Все права защищены.",

    bookDetails: "Детали книги",
    ratingText: (n)=>`4.5 (${n} отзывов)`,
    descriptionMissing: "Описание отсутствует",
    unknownAuthor: "Неизвестный автор",
    noPrice: "Цена не указана",
    noGenre: "Не указан",
    addToCartBtn: "В корзину",
    buyInKaspi: "Купить в Kaspi",
    characteristics: "Характеристики",
    genre: "Жанр:",
    year: "Год издания:",
    pages: "Страниц:",
    isbn: "ISBN:",
    recommendations: "Рекомендуемые книги",
    noRecs: "Нет рекомендаций",

    cartTitle: "Корзина",
    emptyCart: "Ваша корзина пуста",
    total: "Общая сумма:",
    checkout: "Оформить заказ",
    checkoutTitle: "Оформление заказа",
    nameLabel: "Имя и фамилия *",
    phoneLabel: "Номер телефона *",
    cityLabel: "Город *",
    addressLabel: "Адрес *",
    paymentMethod: "Способ оплаты *",
    cash: "Наличными при получении",
    card: "Банковской картой онлайн",
    confirmOrder: "Подтвердить заказ",
    chooseCity: "Выберите город",
    cityAst: "Астана",
    cityAlm: "Алматы",
    cityShy: "Шымкент",
    cityKar: "Караганда",
    cityOther: "Другой",
    favoritesTitle: "Избранное",
    emptyFavorites: "У вас пока нет избранных книг",
    pdfTitle: "Просмотр PDF",

    viewDetails: "Смотреть",
    inCart: "В корзину",
    inFav: "В избранное",
    openPdf: "Открыть PDF",

    addedToCart: (t)=>`«${t}» добавлена в корзину`,
    removedFromCart: (t)=>`«${t}» удалена из корзины`,
    addedToFav: (t)=>`«${t}» добавлена в избранное`,
    removedFromFav: (t)=>`«${t}» удалена из избранного`,
  }
};



function setLanguage(lang) {
  currentLang = lang;
  localStorage.setItem("lang", lang);

  const t = translations[lang];

  // Меню
  document.querySelector('a[href="#catalog"]').textContent = t.catalog;
  document.querySelector('a[href="#about"]').textContent = t.about;
  document.querySelector('a[href="#benefits"]').textContent = t.benefits;
  document.querySelector('a[href="#contacts"]').textContent = t.contacts;

  // Hero
  document.querySelector(".hero-title").textContent = t.welcome;
  document.querySelector(".hero-pattern p").textContent = t.heroText;
  document.querySelector(".hero-pattern a").innerHTML = `<i class="fas fa-book mr-2"></i> ${t.seeCatalog}`;

  // Поиск
  document.getElementById("searchInput").placeholder = t.search;
  document.getElementById("searchInputMobile").placeholder = t.search;

  // Статистика
  document.querySelectorAll(".grid .p-4 .text-gray-600")[0].textContent = t.statsBooks;
  document.querySelectorAll(".grid .p-4 .text-gray-600")[1].textContent = t.statsClients;
  document.querySelectorAll(".grid .p-4 .text-gray-600")[2].textContent = t.statsYears;
  document.querySelectorAll(".grid .p-4 .text-gray-600")[3].textContent = t.statsSupport;
}

let currentLang = localStorage.getItem("lang") || "kk";
    
    /* ======================== ИНИЦИАЛИЗАЦИЯ ======================== */
    document.addEventListener('DOMContentLoaded', () => {
      loadBooksFromGoogleSheets();
      updateCartUI();
      updateFavoritesUI();
      initEventListeners();
      initDemoData(); // fallback, если таблица не доступна
    });
    
    function initEventListeners() {
      cartButton.addEventListener('click', () => toggleModal(cartModal));
      closeCart.addEventListener('click', () => toggleModal(cartModal));
      closeCheckout.addEventListener('click', () => toggleModal(checkoutModal));
      closePdf.addEventListener('click', () => toggleModal(pdfModal));
      closeFavorites.addEventListener('click', () => toggleModal(favoritesModal));
      closeBookDetail.addEventListener('click', () => toggleModal(bookDetailModal));
    
      checkoutButton.addEventListener('click', () => { toggleModal(cartModal); toggleModal(checkoutModal); });
      checkoutForm.addEventListener('submit', handleOrderSubmit);
    
      const triggerFilter = () => filterBooks();
      searchInput.addEventListener('input', triggerFilter);
      searchInputMobile.addEventListener('input', triggerFilter);
      genreFilter.addEventListener('change', triggerFilter);
      priceFilter.addEventListener('change', triggerFilter);
      sortFilter.addEventListener('change', triggerFilter);
    
      favoritesButton.addEventListener('click', () => { renderFavorites(); toggleModal(favoritesModal); });
    
      mobileMenuButton.addEventListener('click', () => mobileMenu.classList.add('active'));
      closeMobileMenu.addEventListener('click', () => mobileMenu.classList.remove('active'));
      backToTop.addEventListener('click', () => window.scrollTo({top:0,behavior:'smooth'}));
      window.addEventListener('scroll', () => { if (pageYOffset>300) backToTop.classList.add('visible'); else backToTop.classList.remove('visible'); });
    
      addToCartDetail.addEventListener('click', () => { if (currentBook) addToCart(currentBook.id); });
      likeButtonDetail.addEventListener('click', () => { if (currentBook) toggleFavorite(currentBook.id, likeButtonDetail); });
    

      const langSwitcher = document.getElementById("langSwitcher");
langSwitcher.value = currentLang;
setLanguage(currentLang);

langSwitcher.addEventListener("change", (e) => {
  setLanguage(e.target.value);
});

      /* === ДЕЛЕГИРОВАНИЕ КЛИКОВ ПО КАРТОЧКАМ === */
      booksContainer.addEventListener('click', (e) => {
        const btn = e.target.closest('button');
        if (btn && booksContainer.contains(btn)) {
          if (btn.classList.contains('add-to-cart')) addToCart(btn.dataset.id);
          else if (btn.classList.contains('like-button')) toggleFavorite(btn.dataset.id, btn);
          else if (btn.classList.contains('view-details')) showBookDetails(btn.dataset.id);
          else if (btn.classList.contains('view-pdf')) viewPdf(btn.dataset.pdf, btn.dataset.title);
          return;
        }

        // Клик по карточке книги
        const card = e.target.closest('.book-card');
        if (card && booksContainer.contains(card)) {
          const id = card.dataset.id;
          if (id) showBookDetails(id);
        }
      });
    
      /* Делегирование в рекомендациях */
      recommendationsContainer.addEventListener('click', (e) => {
        const btn = e.target.closest('button');
        if (!btn) return;
        if (btn.classList.contains('view-details')) showBookDetails(btn.dataset.id);
      });
      
      /* Делегирование в избранном */
      favoritesContainer.addEventListener('click', (e) => {
        const btn = e.target.closest('button');
        if (!btn) return;
        if (btn.classList.contains('add-to-cart')) addToCart(btn.dataset.id);
        if (btn.classList.contains('view-details')) showBookDetails(btn.dataset.id);
      });
    }
    
    /* ======================== ДЕМО-ФОЛЛБЭК ======================== */
    function initDemoData() {
      setTimeout(() => {
        if (books.length === 0) {
          books = [
            {
              id: '1',
              title: 'Война и мир',
              author: 'Лев Толстой',
              description: 'Великий роман-эпопея Льва Толстого, описывающий русское общество в эпоху войн против Наполеона в 1805-1812 годах. Один из величайших романов мировой литературы.',
              genre: 'Классика',
              price: '4500',
              image: 'https://drive.google.com/file/d/1sWfacPCyu1255wL8J1r-o9_jv2ApfoHZ/view?usp=drive_link,https://drive.google.com/file/d/1jh2w_Kt9mJ8IIFQV8fxaI-3wC1qC9APc/view?usp=drive_link',
              pdf: 'https://drive.google.com/file/d/1jh2w_Kt9mJ8IIFQV8fxaI-3wC1qC9APc/view?usp=drive_link'
            },
            {
              id: '2',
              title: 'Преступление и наказание',
              author: 'Федор Достоевский',
              description: 'Роман Федора Достоевского, в котором исследуются психологические последствия преступления, совершенного главным героем, Родионом Раскольниковым.',
              genre: 'Классика',
              price: '3800',
              image: 'https://drive.google.com/file/d/1sWfacPCyu1255wL8J1r-o9_jv2ApfoHZ/view?usp=drive_link',
              pdf: ''
            },
            {
              id: '3',
              title: 'Мастер и Маргарита',
              author: 'Михаил Булгаков',
              description: 'Легендарный роман Михаила Булгакова, сочетающий в себе элементы сатиры, фантастики и философской притчи. Действие происходит в Москве 1930-х годов и в древнем Иерусалиме.',
              genre: 'Классика',
              price: '4200',
              image: 'https://drive.google.com/file/d/1sWfacPCyu1255wL8J1r-o9_jv2ApfoHZ/view?usp=drive_link',
              pdf: ''
            },
            {
              id: '4',
              title: '1984',
              author: 'Джордж Оруэлл',
              description: 'Знаковый роман-антиутопия Джорджа Оруэлла, изображающий тоталитарное общество под постоянным контролем Большого Брата. Книга стала символом борьбы за свободу и права человека.',
              genre: 'Антиутопия',
              price: '3900',
              image: 'https://drive.google.com/file/d/1sWfacPCyu1255wL8J1r-o9_jv2ApfoHZ/view?usp=drive_link',
              pdf: ''
            }
          ];
          renderBooks(books);
          populateGenreFilter(books);
        }
      }, 1500);
    }
    
    /* ======================== ЗАГРУЗКА ИЗ SHEETS ======================== */
    async function loadBooksFromGoogleSheets() {
  try {
    const url = `https://docs.google.com/spreadsheets/d/${GOOGLE_SHEETS_ID}/gviz/tq?tqx=out:json&headers=1`;
    const r = await fetch(url);
    const t = await r.text();

    // Некоторые ответы имеют другой префикс длиной 47…52 символа.
    // Надёжнее вырезать по первой скобке:
    const start = t.indexOf('{');
    const end   = t.lastIndexOf('}');
    const json  = JSON.parse(t.slice(start, end + 1));

    const table = json?.table;
    const rows  = table?.rows || [];
    const cols  = table?.cols || [];

    let headers = cols.map(c => (c.label || '').trim().toLowerCase());
    let dataRows = rows;
    const labelsMissing = headers.every(h => !h);
    if (labelsMissing && rows.length) {
      headers = rows[0].c.map(c => getCellString(c).toLowerCase());
      dataRows = rows.slice(1);
    }

    books = dataRows.map((row, idx) => {
  const obj = {};
  (row.c || []).forEach((cell, i) => {
    const key = headers[i] || `col_${i}`;
    obj[key] = getCellString(cell);
  });
  return obj;
}).map((b, i) => ({
  id: (b.id || String(i + 1)).trim(),
  title: b.title || '',
  author: b.author || '',
  description: b.description || '',
  genre: b.genre || '',
  price: b.price || '',
  image: b.image || '',
  pdf: b.pdf || '',
  kaspi_link: b.kaspi_link || ''   // <— ДОБАВИЛИ
}));

    renderBooks(books);
    populateGenreFilter(books);
  } catch (e) {
    console.error('Sheets error:', e);
    // Чтобы страница "дорисовалась", убираем спиннер и показываем пустую сетку
    renderBooks([]);
  }
}

function getCellString(cell) {
  if (!cell) return '';

  // 1) Явная формула HYPERLINK("url","label")
  if (typeof cell.f === 'string' && /HYPERLINK\s*\(/i.test(cell.f)) {
    const m = cell.f.match(/HYPERLINK\s*\(\s*"([^"]+)"/i);
    if (m && m[1]) return m[1].trim();
  }

  // 2) Попробовать вытащить любой http(s) URL из форматированного или «сырого» значения
  const combined = [cell.f, cell.v].filter(Boolean).map(String).join(' ');
  const urlMatch = combined.match(/https?:\/\/[^\s")]+/i);
  if (urlMatch) return urlMatch[0].trim();

  // 3) Обычное значение как строка
  if (cell.v != null) return String(cell.v).trim();

  return '';
}
    
    /* ======================== РЕНДЕР КАРТОЧЕК ======================== */
    function renderBooks(list) {
      booksContainer.innerHTML = '';
      if (!list.length) {
        booksContainer.innerHTML = '<p class="text-center text-gray-500 py-10 col-span-full">Книги не найдены</p>';
        return;
      }
    
      list.forEach(book => {
        const isFav = favorites.includes(String(book.id));
        const mainCdn = driveImage(book.image);
const mainUc  = (function(){
  const id = getDriveId(book.image);
  return id ? `https://drive.google.com/uc?export=view&id=${id}` : '';
})();
const main = mainCdn || mainUc || 'https://via.placeholder.com/300x400?text=No+Image';

        const el = document.createElement('div');
        el.className = 'book-card bg-white rounded-lg overflow-hidden shadow-md';
        el.dataset.id = book.id;
        el.innerHTML = `
          <div class="h-48 overflow-hidden">
            <img src="${main}"
     alt="${book.title}"
     class="w-full h-full object-cover"
     onerror="
       if(this.dataset.altsrc){
         this.src=this.dataset.altsrc; this.dataset.altsrc='';
       } else {
         this.src='https://via.placeholder.com/300x400?text=No+Image';
       }"
     data-altsrc="${mainUc}">

          </div>
          <div class="p-4">
            <h3 class="font-bold text-lg mb-1 truncate">${book.title}</h3>
            <p class="text-gray-600 text-sm mb-2">${book.author || 'Неизвестный автор'}</p>
            <p class="text-sm text-gray-700 mb-3 line-clamp-2">${book.description || 'Описание отсутствует'}</p>
            <div class="flex justify-between items-center mb-3">
              <span class="text-primary font-bold">${book.price ? parseInt(book.price).toLocaleString('ru-RU') + ' ₸' : 'Цена не указана'}</span>
              <span class="bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded">${book.genre || 'Без жанра'}</span>
            </div>
            <div class="flex justify-between">
  <button class="view-details bg-gray-100 text-gray-700 px-3 py-1 rounded text-sm hover:bg-gray-200 transition" data-id="${String(book.id)}">
    <i class="fas fa-eye mr-1"></i> 
  </button>
  <div class="flex items-center space-x-1">
   ${book.kaspi_link ? `
  <a href="${book.kaspi_link}" target="_blank" rel="noopener"
     class="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700 transition flex items-center space-x-1" 
     title="Купить в Kaspi">
    <img src="kaspi.png" alt="Kaspi" class="w-5 h-5">
    <span>Kaspi</span>
  </a>` : ''
}
    <button class="add-to-cart bg-primary text-white px-3 py-1 rounded text-sm hover:bg-secondary transition" data-id="${String(book.id)}" title="В корзину">
      <i class="fas fa-shopping-cart mr-1"></i>
    </button>
    <button class="like-button p-2 ${isFav ? 'text-red-500' : 'text-gray-400'} hover:text-red-500" data-id="${String(book.id)}" title="В избранное">
      <i class="fas fa-heart"></i>
    </button>
    ${book.pdf ? `<button class="view-pdf p-2 text-gray-400 hover:text-primary" data-pdf="${book.pdf}" data-title="${book.title}" title="Открыть PDF">
      <i class="fas fa-file-pdf"></i>
    </button>` : ''}
  </div>
</div>
          </div>`;
        booksContainer.appendChild(el);
      });
    }
    
    function showBookDetails(id) {
  currentBook = findBook(id);
  if (!currentBook) return;

  // тексты
  const isFav = favorites.includes(asId(id));
  detailTitle.textContent = currentBook.title;
  detailAuthor.textContent = currentBook.author || 'Неизвестный автор';
  detailDescription.textContent = currentBook.description || 'Описание отсутствует';
  detailPrice.textContent = currentBook.price ? parseInt(currentBook.price).toLocaleString('ru-RU') + ' ₸' : 'Цена не указана';
  detailGenre.textContent = currentBook.genre || 'Не указан';
  likeButtonDetail.classList.remove('text-red-500','text-gray-400');
  likeButtonDetail.classList.add(isFav ? 'text-red-500' : 'text-gray-400');

  // галерея из нескольких ссылок
  const gallery = document.getElementById('detailGallery');
  gallery.innerHTML = '';

  const imgs = processImageUrls(currentBook.image);

  // Кнопка "Купить в Kaspi" в деталях
if (currentBook.kaspi_link) {
  kaspiBuyDetail.href = currentBook.kaspi_link;
  kaspiBuyDetail.classList.remove('hidden');
} else {
  kaspiBuyDetail.href = '#';
  kaspiBuyDetail.classList.add('hidden');
}

  if (imgs.length === 0) {
    gallery.innerHTML = `<img src="https://via.placeholder.com/500x700?text=No+Image" class="w-full h-auto rounded-lg shadow">`;
  } else {
    // основной снимок
    const main = document.createElement('img');
    main.id = 'detailMainImage';
    main.src = imgs[0];
    main.alt = currentBook.title;
    main.className = 'w-full h-auto rounded-lg shadow mb-2';
    main.onerror = () => main.src = 'https://via.placeholder.com/500x700?text=No+Image';
    gallery.appendChild(main);

    // превьюшки
    if (imgs.length > 1) {
      const thumbs = document.createElement('div');
      thumbs.id = 'detailThumbs';
      thumbs.className = 'flex gap-2 flex-wrap';
      imgs.forEach((src) => {
        const t = document.createElement('img');
        t.src = src;
        t.className = 'w-16 h-20 object-cover rounded cursor-pointer border border-gray-200';
        t.onerror = () => (t.src = 'https://via.placeholder.com/80x100?text=No+Image');
        t.onclick = () => { main.src = src; };
        thumbs.appendChild(t);
      });
      gallery.appendChild(thumbs);
    }
  }

  // рекомендации
  showRecommendations(currentBook.genre, currentBook.id);

  // открыть модалку
  toggleModal(bookDetailModal);
}
    
    function showRecommendations(genre, excludeId) {
      const recs = books.filter(b => b.genre === genre && asId(b.id) !== asId(excludeId)).slice(0, 4);
      recommendationsContainer.innerHTML = '';
      
      if (recs.length === 0) {
        recommendationsContainer.innerHTML = '<p class="text-gray-500 col-span-full text-center py-4">Нет рекомендаций</p>';
        return;
      }
      
      recs.forEach(b => {
        const img = processImageUrls(b.image)[0] || 'https://via.placeholder.com/200x300?text=No+Image';
        const el = document.createElement('div');
        el.className = 'recommendation-card bg-white rounded-lg overflow-hidden shadow-md';
        el.innerHTML = `
          <div class="h-40 overflow-hidden">
            <img src="${img}" class="w-full h-full object-cover" 
                 onerror="this.src='https://via.placeholder.com/200x300?text=No+Image';" 
                 alt="${b.title}">
          </div>
          <div class="p-3">
            <h4 class="font-bold text-sm mb-1 truncate">${b.title}</h4>
            <p class="text-gray-600 text-xs mb-2">${b.author || 'Неизвестный автор'}</p>
            <div class="flex justify-between items-center">
              <span class="text-primary font-bold text-sm">${b.price ? parseInt(b.price).toLocaleString('ru-RU') + ' ₸' : 'Цена не указана'}</span>
              <button class="view-details bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs hover:bg-gray-200 transition" data-id="${asId(b.id)}">
                <i class="fas fa-eye"></i>
              </button>
            </div>
          </div>`;
        recommendationsContainer.appendChild(el);
      });
    }
    
    /* ======================== ФИЛЬТРЫ ======================== */
    function populateGenreFilter(list) {
      const genres = [...new Set(list.map(b => b.genre).filter(Boolean))].sort();
      genreFilter.innerHTML = '<option value="">Все жанры</option>';
      genres.forEach(g => {
        const o = document.createElement('option'); 
        o.value = g; 
        o.textContent = g;
        genreFilter.appendChild(o);
      });
    }
    
    function filterBooks() {
      const search = (searchInput.value || searchInputMobile.value || '').toLowerCase();
      const g = genreFilter.value, p = priceFilter.value, s = sortFilter.value;
    
      let filtered = books.filter(b => {
        const matchesSearch = (b.title||'').toLowerCase().includes(search) || (b.author||'').toLowerCase().includes(search);
        const matchesGenre  = !g || b.genre === g;
        const matchesPrice  = !p || checkPriceFilter(b.price, p);
        return matchesSearch && matchesGenre && matchesPrice;
      });
    
      if (s==='price-asc')  filtered.sort((a,b)=>(+a.price||0)-(+b.price||0));
      else if (s==='price-desc') filtered.sort((a,b)=>(+b.price||0)-(+a.price||0));
      else if (s==='newest') filtered.sort((a,b)=>(+b.id||0)-(+a.id||0));
    
      renderBooks(filtered);
    }
    
    function checkPriceFilter(price, filter) {
      const v = parseInt(price)||0;
      if (filter==='0-5000') return v<=5000;
      if (filter==='5000-10000') return v>=5000 && v<=10000;
      if (filter==='10000-20000') return v>=10000 && v<=20000;
      if (filter==='20000+') return v>=20000;
      return true;
    }
    
    /* ======================== КОРЗИНА / ИЗБРАННОЕ ======================== */
    function addToCart(id) {
  const b = findBook(id);
  if (!b) return;

  const key = asId(id);

  // Готовим корректную картинку для корзины (одна ссылка + фоллбэк)
  const imgCdn = driveImage(b.image);
  const imgUc  = (function () {
    const did = getDriveId(b.image);
    return did ? `https://drive.google.com/uc?export=view&id=${did}` : '';
  })();
  const img = imgCdn || imgUc || 'https://via.placeholder.com/300x400?text=No+Image';

  // Если уже есть в корзине — увеличиваем количество
  const ex = cart.find(i => asId(i.id) === key);
  if (ex) {
    ex.quantity += 1;
  } else {
    cart.push({ id: key, title: b.title, price: b.price, image: img, quantity: 1 });
  }

  localStorage.setItem('cart', JSON.stringify(cart));
  updateCartUI();
  showNotification(`"${b.title}" добавлена в корзину`, 'success');

  const icon = document.querySelector('.fa-shopping-cart').parentElement;
  icon.classList.add('like-animation');
  setTimeout(() => icon.classList.remove('like-animation'), 500);
}
    
    function updateCartUI() {
      cartCount.textContent = cart.reduce((t,i)=>t+i.quantity,0);
      checkoutButton.disabled = cart.length===0;
      
      if (!cart.length) {
        cartItems.innerHTML = `<div id="emptyCart" class="text-center py-10"><i class="fas fa-shopping-cart text-gray-300 text-4xl mb-3"></i><p class="text-gray-500">Ваша корзина пуста</p></div>`;
        cartTotal.textContent = '0 ₸'; 
        return;
      }
      
      cartItems.innerHTML = '';
      let total = 0;
      
      cart.forEach(i=>{
        const sum = (parseInt(i.price)||0)*i.quantity; 
        total+=sum;
        const el=document.createElement('div'); 
        el.className='cart-item flex items-center border-b pb-4';
        el.innerHTML=`
          <img src="${i.image}" class="w-16 h-20 object-cover rounded" onerror="this.src='https://via.placeholder.com/300x400?text=No+Image';">
          <div class="ml-4 flex-grow">
            <h4 class="font-medium">${i.title}</h4>
            <p class="text-gray-600">${parseInt(i.price).toLocaleString('ru-RU')} ₸</p>
          </div>
          <div class="flex items-center">
            <button class="decrease-quantity text-gray-500 px-2 py-1" data-id="${asId(i.id)}">-</button>
            <span class="mx-2">${i.quantity}</span>
            <button class="increase-quantity text-gray-500 px-2 py-1" data-id="${asId(i.id)}">+</button>
            <button class="remove-from-cart text-red-500 ml-4" data-id="${asId(i.id)}">
              <i class="fas fa-trash"></i>
            </button>
          </div>`;
        cartItems.appendChild(el);
      });
      
      cartTotal.textContent = total.toLocaleString('ru-RU') + ' ₸';
    
      // Добавление обработчиков событий для кнопок в корзине
      cartItems.querySelectorAll('.increase-quantity').forEach(b => {
        b.onclick = (e) => {
          const id = e.currentTarget.dataset.id;
          const it = cart.find(x => asId(x.id) === asId(id));
          if (it) {
            it.quantity++;
            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartUI();
          }
        };
      });
      
      cartItems.querySelectorAll('.decrease-quantity').forEach(b => {
        b.onclick = (e) => {
          const id = e.currentTarget.dataset.id;
          const it = cart.find(x => asId(x.id) === asId(id));
          if (it) {
            it.quantity--;
            if (it.quantity <= 0) cart = cart.filter(x => asId(x.id) !== asId(id));
            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartUI();
          }
        };
      });
      
      cartItems.querySelectorAll('.remove-from-cart').forEach(b => {
        b.onclick = (e) => {
          const id = e.currentTarget.dataset.id;
          const it = cart.find(x => asId(x.id) === asId(id));
          cart = cart.filter(x => asId(x.id) !== asId(id));
          localStorage.setItem('cart', JSON.stringify(cart));
          updateCartUI();
          if (it) showNotification(`"${it.title}" удалена из корзины`);
        };
      });
    }
    
    function updateFavoritesUI() { 
      favoritesCount.textContent = favorites.length; 
    }
    
    function toggleFavorite(id, btn) {
      const b = findBook(id); 
      const key = asId(id); 
      const idx = favorites.findIndex(f => asId(f) === key);
      
      if (idx === -1) {
        favorites.push(key); 
        btn?.classList.replace('text-gray-400', 'text-red-500'); 
        showNotification(`"${b?.title || 'Книга'}" добавлена в избранное`, 'success');
      } else {
        favorites.splice(idx, 1); 
        btn?.classList.replace('text-red-500', 'text-gray-400'); 
        showNotification(`"${b?.title || 'Книга'}" удалена из избранного`);
      }
      
      if (currentBook && asId(currentBook.id) === key) {
        likeButtonDetail.classList.remove('text-red-500', 'text-gray-400');
        likeButtonDetail.classList.add(idx === -1 ? 'text-red-500' : 'text-gray-400');
      }
      
      btn?.classList.add('like-animation');
      setTimeout(() => btn?.classList.remove('like-animation'), 500);
      localStorage.setItem('favorites', JSON.stringify(favorites));
      updateFavoritesUI();
    }
    
    function renderFavorites() {
      const favBooks = books.filter(b => favorites.includes(asId(b.id)));
      
      if (!favBooks.length) {
        favoritesContainer.innerHTML = `<div id="emptyFavorites" class="text-center py-10 col-span-2"><i class="fas fa-heart text-gray-300 text-4xl mb-3"></i><p class="text-gray-500">У вас пока нет избранных книг</p></div>`;
        return;
      }
      
      favoritesContainer.innerHTML = '';
      
      favBooks.forEach(b => {
        const img = processImageUrls(b.image)[0] || 'https://via.placeholder.com/200x300?text=No+Image';
        const el = document.createElement('div');
        el.className = 'bg-white rounded-lg overflow-hidden shadow-md';
        el.innerHTML = `
          <div class="h-40 overflow-hidden">
            <img src="${img}" class="w-full h-full object-cover" onerror="this.src='https://via.placeholder.com/200x300?text=No+Image';">
          </div>
          <div class="p-3">
            <h3 class="font-bold text-md mb-1 truncate">${b.title}</h3>
            <p class="text-gray-600 text-sm mb-2">${b.author || 'Неизвестный автор'}</p>
            <div class="flex justify-between items-center">
              <span class="text-primary font-bold">${b.price ? parseInt(b.price).toLocaleString('ru-RU') + ' ₸' : 'Цена не указана'}</span>
              <div class="flex space-x-1">
                <button class="add-to-cart bg-primary text-white px-2 py-1 rounded text-xs hover:bg-secondary transition" data-id="${asId(b.id)}">
                  <i class="fas fa-shopping-cart"></i>
                </button>
                <button class="view-details bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs hover:bg-gray-200 transition" data-id="${asId(b.id)}">
                  <i class="fas fa-eye"></i>
                </button>
              </div>
            </div>
          </div>`;
        favoritesContainer.appendChild(el);
      });
    }
    
    /* ======================== PDF ======================== */
    function viewPdf(rawUrl, title) { 
      pdfTitle.textContent = title; 
      pdfViewer.src = drivePdf(rawUrl); 
      toggleModal(pdfModal); 
    }
    
    /* ======================== ОФОРМЛЕНИЕ ЗАКАЗА ======================== */
    function handleOrderSubmit(e) {
      e.preventDefault();
      const name = document.getElementById('name').value || '';
      const phone = document.getElementById('phone').value || '';
      const email = document.getElementById('email').value || '';
      const city = document.getElementById('city').value || '';
      const address = document.getElementById('address').value || '';
      const payment = (document.querySelector('input[name="payment"]:checked') || {value: 'cash'}).value;
      const total = cart.reduce((s, i) => s + ((parseInt(i.price) || 0) * i.quantity), 0);
      
      let msg = `Новый заказ из Astana Kitap:%0A%0AИмя: ${name}%0AТелефон: ${phone}%0A${email ? `Email: ${email}%0A` : ''}Город: ${city}%0AАдрес: ${address}%0AСпособ оплаты: ${payment === 'cash' ? 'Наличными при получении' : 'Банковской картой онлайн'}%0A%0AЗаказанные товары:%0A`;
      
      cart.forEach(i => {
        msg += `- ${i.title} (${i.quantity} x ${parseInt(i.price).toLocaleString('ru-RU')} ₸)%0A`;
      });
      
      msg += `%0AОбщая сумма: ${total.toLocaleString('ru-RU')} ₸`;
      
      window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${msg}`, '_blank');
      
      cart = [];
      localStorage.setItem('cart', JSON.stringify(cart));
      updateCartUI();
      toggleModal(checkoutModal);
      showNotification('Ваш заказ успешно оформлен! Сообщение отправлено администратору в WhatsApp.', 'success');
      checkoutForm.reset();
    }
    </script>
</body>
</html>